## 爬取某安全网站的视频

背景: 有个同事去年花重金购买了某安全网站的逆向课程, 于是不要脸的向其借了账号, 本来打算过年看看, 谁知道这个课程貌似还会过期... 于是萌生将视频保存下来的想法..

<br />
### 开干！
第一步当然是打开视频播放的页面分析这个视频的原地址和格式是什么, 经过简单的抓包分析后, 我发现事情没有想象的那么容易. 首先视频是被切割后的.ts文件, 每次都进行分段加载. 这个到好说, 只要请求模拟的足够OK, 也能拿到视频文件. 

但是我发现我高兴早了, 每一个请求ts文件的的请求头上, 都有让人眼花缭乱的key和value... 而且每一个都长得不一样... 这就很搞心态, 于是准备转战自动化浏览器去拦截这些请求自动保存 (这样最起码不用自己挂着下, 随便找个服务器丢上去就行了)

<br /> 
### Puppeteer
浏览器自动化首选当然是Puppeteer了, 我的目标也很明确, 将cookie种进去(保持登录态), 访问指定的网址, 之后对指定的请求进行拦截, 将响应报文保存起来就可以了.

结果我发现我又高兴早了, 从用户浏览器上摘下来的cookie, 通过set到puppeter中, 随后访问视频网站, 结果视频网站一直提示我未登录, 好家伙...

想了想会不会是这个网站有做什么校验, 别把同事的账号玩坏了... 于是就想把这个cookie转移到我的另一台windows上, 反正也不用, 如果是puppeteer的锅, 那用windows挂着也行. 

<br /> 
### 转移Cookie
于是我找到了Chrome保存所有Cookie的地方, 并且拿到了这个文件, 通过010Editor打开发现其实就是个sqlite文件, 哇贼开心, 赶紧打开看看.

不看不知道, 一看傻眼了, 数据库能正常打开, 里面cookie的key、domain什么的也都有, 各种参数都在, 唯独这个value 是一个Blob类型的, 而且字段名称叫encrypt_value. 

确实, 谷歌这么大的公司怎么可能会把Cookie这种东西随便存呢？

<br />
最终折腾了一番后发现, puppeteer登录态不对是由于cookie设置的不够力度精细导致的. 我都是抓一个请求, 直接从headers里面扣出来cookie然后去设置... 这样其实不太对. 这里强烈推荐```Edit this Cookie```这个Chrome插件, 可以直接导出一个cookie列表, 其中包含了每个cookie的domain和是否是httpOnly这种参数

<br /> 
### 使用puppeteer进行请求拦截
登录上之后抓紧开始拦截我需要的请求, 谁曾想这时...

我发现我高兴的早了, 用puppeteer登录上还不到2分钟, 网站就提醒我账户异常, 退出登录了. 这给我吓得不轻(担心同事账号被我搞坏 & 担心我本地的的cookie失效,看都没法看)


<br />
这下可咋弄... 不可能我用其他的抓包工具一个一个ts文件自己往外导吧...

诶！抓包有没有自动化的东西？


<br />
### Mutmproxy大法！
Mutmproxy是一个命令行的抓包工具, 可以用brew或者pip进行安装, 过程就不多做赘述, 他牛逼在: 可以使用python配合抓包(将请求和响应转发到python里面), 这样一来, 我在python里就可以做任何我想做的操作了！！！ 开心！

详细的使用教程可以自己搜... (配合Omega插件一起用)

<br />
简单的写了一下python脚本, 是可以抓了, 可以自动保存视频了，跑了一下午抓回来了几个视频. 

我发现我又tnnd高兴早了, 通过这种方式抓包虽然可以实现每个ts文件的自动拦截保存, 但是一旦这个课程结束我需要换下一个课程接着抓的时候, 就需要手动填写这章的内容， 要保存的文件名, 而且要盯着教程, 不停的按快进键才能下载的快一点, 不过有时候按过了可能会有些ts没下载到.


<br />
### 祭出杀手锏
观察视频播放时的控制台输出可以看到, 整个视频组建使用的是videojs进行渲染和操作的, 那videojs的教程满天飞一查一大把, 于是就开始尝试通过js在控制台操作页面实现无人管控, 自动切换课程.

调用videojs对视频进行调速(实验发现最大16倍), 使用原生js对页面控件进行监控, 一旦扫描到就进行点击

u1s1, 这招真好使, 但是一旦自动切换了课程, python那边并不知道这次的课程是什么, 也就意味着当几百个视频下载完之后我需要手动分类, 我可不愿意这样, 于是开始想办法让浏览器控制台和python通信..

第一反应当然是本地用python架一个服务器, js在控制台发请求过来, 尝试了之后发现存在跨域问题, 无法解决。

那只好通过最笨的办法解决了 -- 存文件到本地, python无限循环尝试读取这个文件, 当读取到之后, 就创建一个新的文件夹, 并且修改新请求过来的保存目录. 这下终于解决了所有的问题！

将js脚本整理后, 放在了油猴插件里运行, 每当页面加载完毕后开始执行. 现在写这篇文档的时候, 后态的油猴、Mutmproxy、Python 一直在稳定的运行着、配合着、download for me...


### 写在最后
当视频的第一大章下载完成后, 我发现这些ts根本打不开，要么都是噪音, 要么没有画面. 和以往爬下来的分段ts不太一样...

# [ts打不开的原因](https://www.jianshu.com/p/1b0adcc7b426)






<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />